version: "2.4"

volumes:
  victoria-metrics:
  garmin-tokens:
  home-assistant-config:

services:
  database:
    image: victoriametrics/victoria-metrics:latest
    hostname: database
    restart: unless-stopped
    # No ports exposed - only accessible via database-auth (vmauth) for security
    volumes:
      - victoria-metrics:/victoria-metrics-data
    command:
      - -storageDataPath=/victoria-metrics-data
      - -retentionPeriod=3y
      - -httpListenAddr=:8181

  database-auth:
    image: victoriametrics/vmauth:latest
    hostname: database-auth
    restart: unless-stopped
    ports:
      - "8427:8427"
    environment:
      - VMAUTH_CONFIG
    command:
      - sh
      - -c
      - 'echo "$$VMAUTH_CONFIG" > /etc/auth.yml && exec vmauth -auth.config=/etc/auth.yml'
    depends_on:
      - database

  https-proxy:
    image: europe-docker.pkg.dev/filiplindqvist-com-ea66d/images/https-proxy:latest
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "443:443"
      - "80:80"
    depends_on:
      - iot-fetcher
      - database-auth
    labels:
      - "wud.watch=true"
      - "wud.watch.digest=true"

  iot-fetcher:
    image: europe-docker.pkg.dev/filiplindqvist-com-ea66d/images/iot-fetcher:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - database-auth
    labels:
      - "wud.watch=true"
      - "wud.watch.digest=true"

  tibber-influx-bridge:
    image: tkhduracell/tibber-influxdb-bridge:latest
    restart: unless-stopped
    depends_on:
      - https-proxy

  garmin-influx-bridge:
    image: europe-docker.pkg.dev/filiplindqvist-com-ea66d/images/garmin-fetch:latest
    restart: unless-stopped
    volumes:
      - garmin-tokens:/home/appuser/.garminconnect
    depends_on:
      - https-proxy
    labels:
      - "wud.watch=true"
      - "wud.watch.digest=true"

  home-assistant:
    image: "ghcr.io/home-assistant/home-assistant:stable"
    volumes:
      - home-assistant-config:/config
    restart: unless-stopped
    network_mode: host
    environment:
      - TZ=Europe/Stockholm

  wud:
    image: getwud/wud
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "3000:3000"
    environment:
      - WUD_WATCHER_LOCAL_WATCHBYDEFAULT=false
      - WUD_WATCHER_LOCAL_CRON=*/5 * * * *
      - WUD_REGISTRY_CUSTOM_GAR_URL=https://europe-docker.pkg.dev
      - WUD_TRIGGER_DOCKER_LOCAL_PRUNE=true