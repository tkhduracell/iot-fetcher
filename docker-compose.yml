services:
  database:
    image: victoriametrics/victoria-metrics:latest
    container_name: victoria-metrics
    hostname: database
    restart: unless-stopped
    ports:
      - "8181:8181"
    volumes:
      - ./volumes/victoria-metrics:/victoria-metrics-data
    command:
      - -storageDataPath=/victoria-metrics-data
      - -retentionPeriod=3y
      - -httpListenAddr=:8181

  database-auth:
    image: victoriametrics/vmauth:latest
    container_name: victoria-metrics-auth
    hostname: database-auth
    restart: unless-stopped
    ports:
      - "8427:8427"
    environment:
      - VMAUTH_CONFIG
    command:
      - sh
      - -c
      - 'echo "$$VMAUTH_CONFIG" > /etc/auth.yml && exec vmauth -auth.config=/etc/auth.yml'
    depends_on:
      - database

  https-proxy:
    build: ./influx-proxy
    container_name: https-proxy
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    depends_on:
      - iot-fetcher
      - database-auth

  iot-fetcher:
    image: europe-docker.pkg.dev/filiplindqvist-com-ea66d/images/iot-fetcher:latest
    container_name: iot-fetcher
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - database-auth

  tibber-influx-bridge:
    image: tkhduracell/tibber-influxdb-bridge:latest
    container_name: tibber-influxdb-bridge
    restart: unless-stopped
    depends_on:
      - https-proxy

  garmin-influx-bridge:
    image: europe-docker.pkg.dev/filiplindqvist-com-ea66d/images/garmin-fetch:latest
    container_name: garmin-influx-bridge
    restart: unless-stopped
    volumes:
      - ./volumes/garmin-tokens:/home/appuser/.garminconnect
    depends_on:
      - https-proxy
