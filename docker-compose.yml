version: "2.4"

volumes:
  database:
  database-config:
  garmin-tokens:
  influx:

services:
  database:
    image: influxdb:2
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    volumes:
      - database:/var/lib/influxdb
      - database-config:/etc/influxdb2/influx-configs.txt
    healthcheck:
      test: influx ping || exit 1
      interval: 30s
      retries: 5
      start_period: 20s
      timeout: 10s

  influx-3:
    build: ./influx-3
    container_name: influxdb-3
    restart: unless-stopped
    ports:
      - "8181:8181"
    volumes:
      - influx:/home/influxdb3/.influxdb3
    command:
      - influxdb3
      - serve
      - --node-id=rpi3
      - --object-store=google
      - --bucket=filiplindqvist-com-ea66d.appspot.com
      - --google-service-account=/home/influxdb3/.influxdb3/gcs-credentials.json
      - --data-dir=/home/influxdb3/.influxdb3

  # HTTPS reverse proxy for InfluxDB v3 (local)
  influx-proxy:
    build: ./influx-proxy
    container_name: caddy-influxdb-proxy
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    depends_on:
      - iot-fetcher
      - influx-3

  iot-fetcher:
    image: europe-docker.pkg.dev/filiplindqvist-com-ea66d/images/iot-fetcher:latest
    container_name: iot-fetcher
    restart: unless-stopped
    ports:
      - "8080:8080"

  tibber-influx-bridge:
    image: tkhduracell/tibber-influxdb-bridge:1.1.1
    container_name: tibber-influxdb-bridge
    restart: unless-stopped
    depends_on:
      - influx-proxy

  garmin-influx-bridge:
    image: europe-docker.pkg.dev/filiplindqvist-com-ea66d/images/garmin-fetch:latest
    container_name: garmin-influx-bridge
    restart: unless-stopped
    volumes:
      - garmin-tokens:/home/appuser/.garminconnect
    depends_on:
      - influx-proxy

